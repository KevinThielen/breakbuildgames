{%- extends "base.html" %}



{%- block content %}
<!-- Fill the book vars for the current page  -->
{% set path = "" %}
{%- if section %}
    {% set path = section.components %}
{%- else %}
    {% set path = page.components %}
{%- endif %}

{%- set root_section = get_section(path=path[0] ~ "/" ~ path[1] ~ "/_index.md") %}

<!-- Get the current page index, the total page count and the next and prev links  -->
{% set next = "" %}
{% set previous = "" %}
{% set current = 0 %}
{% set found_current = false %}
{% set total = 0 %}

<!-- Check if current page is the title page -->
{% if path == root_section.components %}
    {% set_global found_current = true %}
{% else %}
    {% set_global previous = root_section.permalink %}
{% endif %}

<!-- Go through all chapters -->
{%- for chapter in root_section.subsections %}
    {%- set chapter_section = get_section(path=chapter) %}

    {% set_global total = total + 1 %}

    <!-- Last page or chapter was current, so this one must be the next one -->
    {% if found_current and next == "" %}
        {% set_global next = chapter_section.permalink %}
    {% endif %}

    <!-- This page is the current one! -->
    {% if not found_current and path == chapter_section.components %}
        {% set_global found_current = true %}
        {% set_global current = total %}
    {% endif %}

    <!-- This page was NOT the current one! So it is potentially the previous of the current one -->
    {% if not found_current %}
          {% set_global previous = chapter_section.permalink %}
    {% endif %}
    
    <!-- Go through all pages in a chapter -->
    {%- for page in chapter_section.pages %} 
        {% set_global total = total + 1 %}
       
        <!-- Last page or chapter was current, so this one must be the next one -->
        {% if found_current and next == "" %}
            {% set_global next = page.permalink %}
        {% endif %}

        <!-- This page is the current one! -->
        {% if not found_current and path == page.components %}
            {% set_global found_current = true %}
            {% set_global current = total %}
        {% endif %}

        <!-- This page was NOT the current one! So it is potentially the previous of the current one -->
        {% if not found_current %}
              {% set_global previous = page.permalink %}
        {% endif %}
    {%- endfor %}
{%- endfor %}

<article>
{%- if section %}
    <h1>{{ section.title }}</h1>
    {{ section.content | safe }}
{% else %}
    <h1>{{ page.title }}</h1>
    {{ page.content | safe }}
{%- endif %}

<nav>
    {% if previous != "" %}
    <a class="previous" href="{{previous}}">←</a>
    {% endif %}
    <span style="padding-left: 2rem; padding-right: 2rem">
        {{ current }} / {{ total }}
    </span>
    {% if next != "" %}
    <a class="next" href="{{next}}">→</a>
    {% endif %}
</nav>

</article>



<div class="toc" aria-hidden="true">
  <div class="toc-sticky">
    <div class="toc-item">

        <!--Header -->
        {% if path == root_section.components %}
            <a class = "chapter chapter_header" href="{{ root_section.permalink | safe }}">{{ root_section.title }}</a>
        {% else %}
            <a class = "chapter_header" href="{{ root_section.permalink | safe }}">{{ root_section.title }}</a>
        {% endif %}

        {% set index = 1 %}

        {%- for chapter in root_section.subsections %}
            {% set sub_index = 1 %}
            {%- set chapter_section = get_section(path=chapter) %}
            <div class="toc-item header">
                {% if path == chapter_section.components %}
                  <a class="chapter" href="{{ chapter_section.permalink | safe }}">{{index}} {{ chapter_section.title }}</a>
                  {% if chapter_section.toc %}
                  {% if chapter_section.toc | length > 1 %}
                      {%- for h in chapter_section.toc %}
                      <div class="toc-item-child">
                        - <a class="subtext" href="{{h.permalink | safe}}">{{ h.title }}</a>
                      </div>
                      {% endfor %}
                      {% endif %}
                  {% endif %}

                {% else %}
                    <a href="{{ chapter_section.permalink | safe }}">{{index}} {{ chapter_section.title }}</a> 
                {% endif %}
            </div>
            
            {%- for page in chapter_section.pages %} 
                <div class="toc-item-child">
                {% if path == page.components %}
                    <a class="chapter" href="{{ page.permalink | safe }}">{{index}}.{{sub_index}} {{page.title | safe }}</a> 
                    {% if page.toc %}
                        {%- for h in page.toc %}
                        <div class="toc-item-child">
                          - <a class="subtext" href="{{h.permalink | safe}}">{{ h.title }}</a>
                        </div>
                        {% endfor %}
                    {% endif %}
                {% else %}
                    <a href="{{ page.permalink | safe }}">{{index}}.{{sub_index}} {{ page.title | safe }}</a> 
                {% endif %}

                {% set_global sub_index = sub_index + 1 %}
                </div>
            {%- endfor %}
        {% set_global index = index + 1 %}
        {%- endfor %}

    <nav>
        {% if previous != "" %}
        <a class="previous" href="{{previous}}">←</a>
        {% endif %}
        <span style="padding-left: 2rem; padding-right: 2rem">
            {{ current }} / {{ total }}
        </span>
        {% if next != "" %}
        <a class="next" href="{{next}}">→</a>
        {% endif %}
    </nav>
  </div>
</div>
{%- endblock content %}
